#include <SPI.h>
#include <Mouse.h>
#include <Keyboard.h>
#include <Usb.h>
#include <hiduniversal.h>
#include <usbhub.h>

USB Usb;
HIDUniversal Hid(&Usb);

class MouseRptParser : public HIDReportParser {
private:
  uint8_t lastButtonState = 0;
  int scrollAccumulator = 0;
  bool backPressed = false;
  bool forwardPressed = false;
  
  // SCROLL SETTINGS
  const int SCROLL_SENSITIVITY = 2;
  const int SCROLL_THRESHOLD = 1;
  
  // SIDE BUTTON CODES
  const uint8_t BACK_BUTTON_CODE = 0x08;
  const uint8_t FORWARD_BUTTON_CODE = 0x10;
  
public:
  virtual void Parse(USBHID *hid, bool is_rpt_id, uint8_t len, uint8_t *buf) {
    if (len == 7) {
      uint8_t clickType = buf[1];
      
      // Movement
      int16_t moveX = (int16_t)((buf[3] << 8) | buf[2]);
      int16_t moveY = (int16_t)((buf[5] << 8) | buf[4]);
      int8_t scroll = (int8_t)buf[6];
      
      // Handle movement
      if (moveX != 0 || moveY != 0) {
        int8_t moveX8 = constrain(moveX, -127, 127);
        int8_t moveY8 = constrain(moveY, -127, 127);
        Mouse.move(moveX8, moveY8, 0);
      }
      
      // Scroll wheel
      if (scroll != 0) {
        scrollAccumulator += scroll * SCROLL_SENSITIVITY;
        if (abs(scrollAccumulator) >= SCROLL_THRESHOLD) {
          Mouse.move(0, 0, scrollAccumulator);
          scrollAccumulator = 0;
        }
      }
      
      // Handle buttons
      handleButtonClicks(clickType);
    }
  }
  
private:
  void handleButtonClicks(uint8_t clickType) {
    // Handle standard mouse buttons
    if (clickType == 0x00) {
      Mouse.release(MOUSE_LEFT);
      Mouse.release(MOUSE_RIGHT);
      Mouse.release(MOUSE_MIDDLE);
    } else {
      if (clickType & 0x01) Mouse.press(MOUSE_LEFT);
      else Mouse.release(MOUSE_LEFT);
      
      if (clickType & 0x02) Mouse.press(MOUSE_RIGHT);
      else Mouse.release(MOUSE_RIGHT);
      
      if (clickType & 0x04) Mouse.press(MOUSE_MIDDLE);
      else Mouse.release(MOUSE_MIDDLE);
    }
    
    // Handle side buttons with keyboard shortcuts
    handleSideButtons(clickType);
  }
  
  void handleSideButtons(uint8_t clickType) {
    // Back button - Browser Back (Alt + Left Arrow)
    if ((clickType & BACK_BUTTON_CODE) && !backPressed) {
      Serial.println("ðŸ”™ BACK - Alt + Left Arrow");
      Keyboard.press(KEY_LEFT_ALT);
      Keyboard.press(0xD8);
      delay(10);
      Keyboard.releaseAll();
      backPressed = true;
    } else if (!(clickType & BACK_BUTTON_CODE)) {
      backPressed = false;
    }
    
    // Forward button - Browser Forward (Alt + Right Arrow)
    if ((clickType & FORWARD_BUTTON_CODE) && !forwardPressed) {
      Serial.println("ðŸ”œ FORWARD - Alt + Right Arrow");
      Keyboard.press(KEY_LEFT_ALT);
      Keyboard.press(0xD7);
      delay(10);
      Keyboard.releaseAll();
      forwardPressed = true;
    } else if (!(clickType & FORWARD_BUTTON_CODE)) {
      forwardPressed = false;
    }
  }
};

MouseRptParser Prs;

// ===== SERIAL COMMAND PROCESSING =====
void processSerialCommands() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\n');
    command.trim();
    
    if (command.startsWith("MOVE")) {
      // Format: "MOVE 10,-5"
      int commaIndex = command.indexOf(',');
      if (commaIndex > 0) {
        int x = command.substring(5, commaIndex).toInt();
        int y = command.substring(commaIndex + 1).toInt();
        Mouse.move(x, y);
        Serial.print("MOVED: ");
        Serial.print(x);
        Serial.print(", ");
        Serial.println(y);
      }
    }
    else if (command.startsWith("CLICK")) {
      // Format: "CLICK LEFT", "CLICK RIGHT", "CLICK MIDDLE"
      String button = command.substring(6);
      if (button == "LEFT") {
        Mouse.click(MOUSE_LEFT);
        Serial.println("CLICK: LEFT");
      } else if (button == "RIGHT") {
        Mouse.click(MOUSE_RIGHT);
        Serial.println("CLICK: RIGHT");
      } else if (button == "MIDDLE") {
        Mouse.click(MOUSE_MIDDLE);
        Serial.println("CLICK: MIDDLE");
      }
    }
    else if (command == "PRESS_LEFT") {
      Mouse.press(MOUSE_LEFT);
      Serial.println("PRESS: LEFT");
    }
    else if (command == "RELEASE_LEFT") {
      Mouse.release(MOUSE_LEFT);
      Serial.println("RELEASE: LEFT");
    }
    else if (command.startsWith("SCROLL")) {
      // Format: "SCROLL 5" or "SCROLL -3"
      int scroll = command.substring(7).toInt();
      Mouse.move(0, 0, scroll);
      Serial.print("SCROLL: ");
      Serial.println(scroll);
    }
    else if (command == "HELP") {
      Serial.println("=== SERIAL COMMANDS ===");
      Serial.println("MOVE x,y    - Move mouse (relative)");
      Serial.println("CLICK LEFT/RIGHT/MIDDLE");
      Serial.println("PRESS_LEFT  - Hold left button");
      Serial.println("RELEASE_LEFT - Release left button");
      Serial.println("SCROLL n    - Scroll wheel");
      Serial.println("HELP        - This message");
    }
  }
}

void setup() {
  Serial.begin(115200);
  Serial.println("=== DUAL MODE MOUSE CONTROLLER ===");
  Serial.println("Mode 1: USB Mouse with side button shortcuts");
  Serial.println("Mode 2: Serial commands from Python");
  Serial.println("Send 'HELP' for serial commands");
  Serial.println("===================================");
  
  if (Usb.Init() == -1) Serial.println("USB Host failed");
  delay(200);
  
  Hid.SetReportParser(0, &Prs);
  Mouse.begin();
  Keyboard.begin();
  
  Serial.println("READY - Both modes active");
}

void loop() {
  // Process USB HID mouse (your original functionality)
  Usb.Task();
  
  // Process serial commands from Python (new functionality)
  processSerialCommands();
  
  delay(5);
}